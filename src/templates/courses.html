{% extends "base.html" %}

{% block content %}
<div class="nav-offset">
<div class="container">
    <div class="bodoni" style="font-size: 2.5rem;">Course Browser</div>
    
    <!-- Search Bar -->
    <div class="search-bar">
        <form action="/courses/search" method="post" class="search-form">
            <input type="hidden" name="searched" value="true">
            <div class="form-group">
                <label class="form-label">Subject</label>
                <select name="subject" class="form-select">
                    <option value="">All Subjects</option>
                    {% for subj in subjects %}
                    <option value="{{ subj.code }}" {% if subj.code == subject %}selected{% endif %}>
                        {{ subj.code }} - {{ subj.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Keyword</label>
                <input 
                    type="text" 
                    name="keyword" 
                    class="form-input" 
                    placeholder="Search course titles..."
                    value="{{ keyword }}"
                >
            </div>
            
            <div class="form-group">
                <label class="form-label">Term</label>
                <select name="term" class="form-select">
                    <option value="1262" {% if term == '1262' %}selected{% endif %}>Spring 2026</option>
                    <option value="1258" {% if term == '1258' %}selected{% endif %}>Fall 2025</option>
                    <option value="1252" {% if term == '1252' %}selected{% endif %}>Spring 2025</option>
                    <option value="1248" {% if term == '1248' %}selected{% endif %}>Fall 2024</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary">
                Search
            </button>
        </form>
    </div>
    
    <!-- Error Message -->
    {% if error_message %}
    <div class="alert alert-error">
        âš ï¸ {{ error_message }}
    </div>
    {% endif %}
    
    <!-- Results -->
    {% if courses %}
    <p class="text-muted mb-2">Found {{ total_count }} course sections</p>
    
    <div class="card-grid">
        {% for course in courses %}
        {% set course_key = (course.subject ~ ' ' ~ course.catalog_nbr, course.class_section) %}
        {% set is_added = course_key in scheduled_keys %}
        <div class="course-card{% if is_added %} course-added{% endif %}">
            <div class="course-header">
                <span class="course-code">{{ course.subject }} {{ course.catalog_nbr }}</span>
                {% if is_added %}
                <span class="badge-added">âœ“ Added</span>
                {% elif course.units %}
                <span class="course-credits">{{ course.units }} credits</span>
                {% endif %}
            </div>
            
            <h4 class="course-title">{{ course.descr }}</h4>
            
            {% if course.instructors %}
            <p class="course-instructor">
                ğŸ‘¤ {{ course.instructors[0].name if course.instructors else 'Staff' }}
            </p>
            {% endif %}
            
            <div class="course-meta">
                {% if course.meetings and course.meetings[0].days %}
                <span class="course-meta-item">
                    ğŸ“… {{ course.meetings[0].days }}
                </span>
                {% endif %}
                
                {% if course.meetings and course.meetings[0].start_time %}
                <span class="course-meta-item">
                    ğŸ• {{ course.meetings[0].start_time | format_time }} - {{ course.meetings[0].end_time | format_time }}
                </span>
                {% endif %}
                
                {% if course.meetings and course.meetings[0].facility_descr %}
                <span class="course-meta-item">
                    ğŸ“ {{ course.meetings[0].facility_descr }}
                </span>
                {% endif %}
            </div>
            
            <div class="mt-2 flex justify-between items-center">
                {% if course.enrollment_total is not none and course.class_capacity is not none %}
                    {% set remaining = course.class_capacity - course.enrollment_total %}
                    {% if remaining > 5 %}
                    <span class="enrollment-status open">âœ“ {{ remaining }} seats open</span>
                    {% elif remaining > 0 %}
                    <span class="enrollment-status waitlist">âš  {{ remaining }} seats left</span>
                    {% else %}
                    <span class="enrollment-status closed">âœ• Full ({{ course.wait_tot or 0 }} waitlist)</span>
                    {% endif %}
                {% endif %}
                
                {% if is_added %}
                <!-- Already added - show remove option -->
                <form action="/schedule/remove" method="post" style="margin: 0;">
                    <input type="hidden" name="user_id" value="{{ user_id }}">
                    <input type="hidden" name="course_id" value="{{ course.subject }} {{ course.catalog_nbr }}">
                    <input type="hidden" name="section_id" value="{{ course.class_section }}">
                    <button type="submit" class="btn btn-ghost btn-sm">âœ• Remove</button>
                </form>
                {% else %}
                <!-- Add to Schedule Form -->
                <form action="/schedule/add" method="post" style="margin: 0;">
                    <input type="hidden" name="user_id" value="{{ user_id }}">
                    <input type="hidden" name="course_id" value="{{ course.subject }} {{ course.catalog_nbr }}">
                    <input type="hidden" name="section_id" value="{{ course.class_section }}">
                    <input type="hidden" name="title" value="{{ course.descr }}">
                    <input type="hidden" name="days" value="{{ course.meetings[0].days if course.meetings else '' }}">
                    <input type="hidden" name="start_time" value="{{ (course.meetings[0].start_time | format_time) if course.meetings else '' }}">
                    <input type="hidden" name="end_time" value="{{ (course.meetings[0].end_time | format_time) if course.meetings else '' }}">
                    <input type="hidden" name="location" value="{{ course.meetings[0].facility_descr if course.meetings else '' }}">
                    <input type="hidden" name="instructor" value="{{ course.instructors[0].name if course.instructors else 'Staff' }}">
                    <button type="submit" class="btn btn-secondary btn-sm">+ Add</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    
    {% elif subject or keyword %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <h3 class="empty-title">No courses found</h3>
        <p class="empty-desc">Try adjusting your search filters or searching for a different subject.</p>
    </div>
    
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ“š</div>
        <h3 class="empty-title">Search for Courses</h3>
        <p class="empty-desc">Use the search filters above to find courses. Try selecting a subject like "CS" or searching for keywords like "machine learning".</p>
    </div>
    {% endif %}
</div>
</div>
{% endblock %}

